@page "/"
@using Microsoft.EntityFrameworkCore
@using PlanMorph.Core.Entities
@using PlanMorph.Core.Entities.Mentorship
@using PlanMorph.Core.Interfaces
@using PlanMorph.Admin.Services
@using PlanMorph.Infrastructure.Data
@using PlanMorph.Infrastructure.Repositories
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject AuthStateService AuthState
@inject NavigationManager Navigation

@if (!AuthState.IsAuthenticated)
{
    <div class="admin-surface text-center mt-5">
        <p>Redirecting to login...</p>
    </div>
}
else
{
    <PageTitle>Dashboard - PlanMorph Admin</PageTitle>

    <section class="admin-hero mb-4">
        <h1 class="mb-2">Management Dashboard</h1>
        <p class="mb-0 text-white-50">Restricted access for management personnel only. Monitor approvals, applications, revenue, and operations from one console.</p>
    </section>

    <div class="row g-3">
        <div class="col-md-6 col-xl-3">
            <div class="admin-stat-card">
                <div class="admin-stat-label">Total Designs</div>
                <div class="admin-stat-value">@totalDesigns</div>
                <div class="admin-stat-sub">@approvedDesigns approved</div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="admin-stat-card warning">
                <div class="admin-stat-label">Pending Design Approvals</div>
                <div class="admin-stat-value">@pendingApprovals</div>
                <a href="designs" class="btn btn-sm btn-outline-light mt-2">Review Designs</a>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="admin-stat-card success">
                <div class="admin-stat-label">Total Orders</div>
                <div class="admin-stat-value">@totalOrders</div>
                <div class="admin-stat-sub">KES @totalRevenue.ToString("N0") paid revenue</div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="admin-stat-card info">
                <div class="admin-stat-label">Active Contracts</div>
                <div class="admin-stat-value">@activeContracts</div>
                <div class="admin-stat-sub">@pendingContracts pending assignment</div>
            </div>
        </div>
    </div>

    @if (pendingProfessionals > 0 || pendingStudentApplications > 0 || pendingApprovals > 0)
    {
        <div class="admin-surface mt-4">
            <h5 class="mb-3">Action Required</h5>
            <div class="d-flex flex-wrap gap-2">
                @if (pendingProfessionals > 0)
                {
                    <a href="users" class="btn btn-warning">@pendingProfessionals pending professional application@(pendingProfessionals > 1 ? "s" : "")</a>
                }
                @if (pendingStudentApplications > 0)
                {
                    <a href="users" class="btn btn-primary">@pendingStudentApplications pending student application@(pendingStudentApplications > 1 ? "s" : "")</a>
                }
                @if (pendingApprovals > 0)
                {
                    <a href="designs" class="btn btn-info">@pendingApprovals pending design approval@(pendingApprovals > 1 ? "s" : "")</a>
                }
            </div>
        </div>
    }

    <div class="row g-3 mt-1">
        <div class="col-lg-7">
            <div class="admin-surface h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Revenue Overview</h5>
                    <span class="text-white-50">Last 6 months</span>
                </div>
                <div class="revenue-metrics mb-3">
                    <div><span>Total Revenue</span><strong>KES @totalRevenue.ToString("N0")</strong></div>
                    <div><span>Platform Commission</span><strong>KES @platformCommission.ToString("N0")</strong></div>
                    <div><span>Professional Payouts</span><strong>KES @architectPayouts.ToString("N0")</strong></div>
                    <div><span>Construction Commissions</span><strong>KES @totalConstructionCommission.ToString("N0")</strong></div>
                </div>

                <div class="admin-chart-bars">
                    @foreach (var point in monthlyRevenuePoints)
                    {
                        <div class="bar-wrap">
                            <div class="bar" style="height:@GetRevenueBarHeight(point.Amount)%"></div>
                            <small>@point.Label</small>
                        </div>
                    }
                </div>
                <div class="text-white-50 mt-2">This month: KES @monthlyRevenue.ToString("N0")</div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="admin-surface h-100">
                <h5 class="mb-3">User Mix</h5>

                <div class="mix-row">
                    <div class="mix-label">Clients</div>
                    <div class="mix-bar"><span style="width:@GetPercent(totalClients, totalUsers)%"></span></div>
                    <div class="mix-value">@totalClients</div>
                </div>
                <div class="mix-row">
                    <div class="mix-label">Architects</div>
                    <div class="mix-bar"><span class="accent-2" style="width:@GetPercent(totalArchitects, totalUsers)%"></span></div>
                    <div class="mix-value">@totalArchitects</div>
                </div>
                <div class="mix-row">
                    <div class="mix-label">Engineers</div>
                    <div class="mix-bar"><span class="accent-3" style="width:@GetPercent(totalEngineers, totalUsers)%"></span></div>
                    <div class="mix-value">@totalEngineers</div>
                </div>
                <div class="mix-row">
                    <div class="mix-label">Contractors</div>
                    <div class="mix-bar"><span class="accent-4" style="width:@GetPercent(totalContractors, totalUsers)%"></span></div>
                    <div class="mix-value">@totalContractors</div>
                </div>
                <hr class="border-white-25" />
                <div class="d-flex justify-content-between text-white-50">
                    <span>Total Users</span>
                    <strong class="text-white">@totalUsers</strong>
                </div>
                <div class="d-flex justify-content-between text-white-50 mt-1">
                    <span>Pending Professional Applications</span>
                    <strong class="text-white">@pendingProfessionals</strong>
                </div>
                <div class="d-flex justify-content-between text-white-50 mt-1">
                    <span>Pending Student Applications</span>
                    <strong class="text-white">@pendingStudentApplications</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-surface mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Pending Orders</h5>
            <div class="d-flex gap-2">
                @if (previousOrders != null && previousOrders.Any())
                {
                    <button class="btn btn-sm btn-outline-light" @onclick="OpenPreviousOrders">View Previous Orders</button>
                }
                <a href="orders" class="btn btn-sm btn-primary">Manage Orders</a>
            </div>
        </div>

        @if (recentOrders == null || !recentOrders.Any())
        {
            <p class="text-white-50 mb-0">No pending orders.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table admin-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Order Number</th>
                            <th>Client</th>
                            <th>Design</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in recentOrders)
                        {
                            <tr>
                                <td>@order.OrderNumber</td>
                                <td>@order.ClientName</td>
                                <td>@order.DesignTitle</td>
                                <td>KES @order.Amount.ToString("N0")</td>
                                <td>
                                    <span class="badge bg-@GetOrderStatusBadge(order.Status)">@order.Status</span>
                                </td>
                                <td>@order.CreatedAt.ToShortDateString()</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    @if (showPreviousOrders)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Previous Orders</h5>
                        <button type="button" class="btn-close" @onclick="ClosePreviousOrders"></button>
                    </div>
                    <div class="modal-body">
                        @if (previousOrders == null || !previousOrders.Any())
                        {
                            <p class="text-muted mb-0">No previous orders found.</p>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order Number</th>
                                            <th>Client</th>
                                            <th>Design</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in previousOrders)
                                        {
                                            <tr>
                                                <td>@order.OrderNumber</td>
                                                <td>@order.ClientName</td>
                                                <td>@order.DesignTitle</td>
                                                <td>KES @order.Amount.ToString("N0")</td>
                                                <td>
                                                    <span class="badge bg-@GetOrderStatusBadge(order.Status)">
                                                        @order.Status
                                                    </span>
                                                </td>
                                                <td>@order.CreatedAt.ToShortDateString()</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="ClosePreviousOrders">Close</button>
                        <a href="orders" class="btn btn-primary">View All Orders</a>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="admin-surface mt-4">
        <h5 class="mb-3">Quick Actions</h5>
        <div class="d-flex flex-wrap gap-2">
            <a href="designs" class="btn btn-outline-primary">Manage Designs</a>
            <a href="orders" class="btn btn-outline-success">View Orders</a>
            <a href="users" class="btn btn-outline-info">Manage Users & Applications</a>
            <a href="contracts" class="btn btn-outline-warning">Construction Contracts</a>
            <a href="verifications" class="btn btn-outline-light">Design Verifications</a>
        </div>
    </div>
}

@code {
    private int totalDesigns = 0;
    private int approvedDesigns = 0;
    private int pendingApprovals = 0;
    private int totalOrders = 0;
    private int activeContracts = 0;
    private int pendingContracts = 0;
    private decimal totalRevenue = 0;
    private decimal platformCommission = 0;
    private decimal architectPayouts = 0;
    private decimal monthlyRevenue = 0;
    private decimal totalConstructionCommission = 0;
    
    private int totalUsers = 0;
    private int totalClients = 0;
    private int totalArchitects = 0;
    private int activeArchitects = 0;
    private int totalEngineers = 0;
    private int activeEngineers = 0;
    private int totalContractors = 0;
    private int pendingProfessionals = 0;
    private int pendingStudentApplications = 0;

    private List<RecentOrderViewModel>? recentOrders;
    private List<RecentOrderViewModel>? previousOrders;
    private List<MonthlyRevenuePoint> monthlyRevenuePoints = new();
    private bool showPreviousOrders;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.InitializeAsync();

        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("login");
            return;
        }

        if (AuthState.UserRole != UserRole.Admin)
        {
            Navigation.NavigateTo("verifications");
            return;
        }
        
        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        // Create a new context for this operation
        await using var context = await DbContextFactory.CreateDbContextAsync();
        var unitOfWork = new UnitOfWork(context);

        // Load design statistics
        var designs = await unitOfWork.Designs.GetAllAsync();
        totalDesigns = designs.Count();
        approvedDesigns = designs.Count(d => d.Status == DesignStatus.Approved);
        pendingApprovals = designs.Count(d => d.Status == DesignStatus.PendingApproval);

        // Load order statistics
        var orders = await unitOfWork.Orders.GetAllAsync();
        totalOrders = orders.Count();
        totalRevenue = orders.Where(o => o.Status == OrderStatus.Paid).Sum(o => o.Amount);

        // Calculate commissions
        platformCommission = totalRevenue * 0.30m; // 30% platform fee
        architectPayouts = totalRevenue * 0.70m; // 70% to architects

        var currentMonth = DateTime.UtcNow.Month;
        var currentYear = DateTime.UtcNow.Year;
        monthlyRevenue = orders
            .Where(o => o.Status == OrderStatus.Paid
                && o.PaidAt.HasValue
                && o.PaidAt.Value.Month == currentMonth
                && o.PaidAt.Value.Year == currentYear)
            .Sum(o => o.Amount);

        monthlyRevenuePoints = BuildMonthlyRevenuePoints(orders);

        // Load contract statistics
        var contracts = await unitOfWork.ConstructionContracts.GetAllAsync();
        activeContracts = contracts.Count(c => c.Status == ContractStatus.InProgress || c.Status == ContractStatus.Assigned);
        pendingContracts = contracts.Count(c => c.Status == ContractStatus.Pending);
        totalConstructionCommission = contracts.Sum(c => c.CommissionAmount);

        // Load user statistics
        var users = await unitOfWork.Users.GetAllAsync();
        totalUsers = users.Count();
        totalClients = users.Count(u => u.Role == UserRole.Client);
        totalArchitects = users.Count(u => u.Role == UserRole.Architect);
        activeArchitects = users.Count(u => u.Role == UserRole.Architect && u.IsActive);
        totalEngineers = users.Count(u => u.Role == UserRole.Engineer);
        activeEngineers = users.Count(u => u.Role == UserRole.Engineer && u.IsActive);
        pendingProfessionals = users.Count(u => (u.Role == UserRole.Architect || u.Role == UserRole.Engineer) && !u.IsActive);
        totalContractors = users.Count(u => u.Role == UserRole.Contractor);
        pendingStudentApplications = await context.StudentApplications.CountAsync(s => s.Status == ApplicationStatus.Pending);

        // Load pending orders (dashboard only)
        recentOrders = new List<RecentOrderViewModel>();
        var recentOrdersList = orders
            .Where(o => o.Status == OrderStatus.Pending)
            .OrderByDescending(o => o.CreatedAt)
            .Take(5);

        foreach (var order in recentOrdersList)
        {
            var client = await unitOfWork.Users.GetByIdAsync(order.ClientId);
            var design = await unitOfWork.Designs.GetByIdAsync(order.DesignId);

            recentOrders.Add(new RecentOrderViewModel
            {
                OrderNumber = order.OrderNumber,
                ClientName = client != null ? $"{client.FirstName} {client.LastName}" : "Unknown",
                DesignTitle = design?.Title ?? "Unknown",
                Amount = order.Amount,
                Status = order.Status.ToString(),
                CreatedAt = order.CreatedAt
            });
        }

        // Load previous orders (non-pending)
        previousOrders = new List<RecentOrderViewModel>();
        var previousOrdersList = orders
            .Where(o => o.Status != OrderStatus.Pending)
            .OrderByDescending(o => o.CreatedAt)
            .Take(20);

        foreach (var order in previousOrdersList)
        {
            var client = await unitOfWork.Users.GetByIdAsync(order.ClientId);
            var design = await unitOfWork.Designs.GetByIdAsync(order.DesignId);

            previousOrders.Add(new RecentOrderViewModel
            {
                OrderNumber = order.OrderNumber,
                ClientName = client != null ? $"{client.FirstName} {client.LastName}" : "Unknown",
                DesignTitle = design?.Title ?? "Unknown",
                Amount = order.Amount,
                Status = order.Status.ToString(),
                CreatedAt = order.CreatedAt
            });
        }
    }

    private void OpenPreviousOrders()
    {
        showPreviousOrders = true;
    }

    private void ClosePreviousOrders()
    {
        showPreviousOrders = false;
    }

    private string GetOrderStatusBadge(string status)
    {
        return status switch
        {
            "Paid" => "success",
            "Pending" => "warning",
            "Completed" => "primary",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }

    private static List<MonthlyRevenuePoint> BuildMonthlyRevenuePoints(IEnumerable<Order> orders)
    {
        var points = new List<MonthlyRevenuePoint>();
        var utcNow = DateTime.UtcNow;

        for (var i = 5; i >= 0; i--)
        {
            var month = utcNow.AddMonths(-i);
            var amount = orders
                .Where(o => o.Status == OrderStatus.Paid
                            && o.PaidAt.HasValue
                            && o.PaidAt.Value.Month == month.Month
                            && o.PaidAt.Value.Year == month.Year)
                .Sum(o => o.Amount);

            points.Add(new MonthlyRevenuePoint
            {
                Label = month.ToString("MMM"),
                Amount = amount
            });
        }

        return points;
    }

    private decimal GetRevenueBarHeight(decimal amount)
    {
        if (monthlyRevenuePoints == null || monthlyRevenuePoints.Count == 0)
            return 5m;

        var max = monthlyRevenuePoints.Max(p => p.Amount);
        if (max <= 0)
            return 5m;

        return Math.Max(5m, Math.Round((amount / max) * 100m, 1));
    }

    private decimal GetPercent(int part, int total)
    {
        if (total <= 0)
            return 0m;

        return Math.Round((decimal)part / total * 100m, 1);
    }

    public class RecentOrderViewModel
    {
        public string OrderNumber { get; set; } = "";
        public string ClientName { get; set; } = "";
        public string DesignTitle { get; set; } = "";
        public decimal Amount { get; set; }
        public string Status { get; set; } = "";
        public DateTime CreatedAt { get; set; }
    }

    public class MonthlyRevenuePoint
    {
        public string Label { get; set; } = "";
        public decimal Amount { get; set; }
    }
}

